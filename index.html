<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Badań Lekarskich</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            color: #212121;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 48px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 4px 8px rgba(0,0,0,0.1);
        }

        .login-logo {
            display: block;
            margin: 0 auto 50px auto;
            max-width: 100%;
            height: auto;
        }

        .login-container h1 {
            text-align: center;
            color: #212121;
            margin-bottom: 32px;
            font-weight: 400;
            font-size: 24px;
        }

        .login-form input {
            width: 100%;
            padding: 16px;
            margin-bottom: 24px;
            border: none;
            border-bottom: 2px solid #e0e0e0;
            border-radius: 0;
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            background: transparent;
            transition: border-color 0.3s;
        }

        .login-form input:focus {
            outline: none;
            border-bottom-color: #1976d2;
        }

        .login-form button {
            width: 100%;
            padding: 14px;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .login-form button:hover {
            background: #1565c0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .login-form button:active {
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .error-message {
            color: #d32f2f;
            text-align: center;
            margin-top: 16px;
            display: none;
            font-size: 14px;
        }

        .copyright {
            text-align: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #e0e0e0;
            color: #757575;
            font-size: 12px;
            line-height: 1.6;
        }

        .copyright p {
            margin: 4px 0;
        }

        .app-container {
            display: none !important;
            max-width: 1400px;
            margin: 0 auto;
        }

        .app-container.active {
            display: block !important;
        }

        /* Panel logowania powinien być zawsze na wierzchu */
        .login-container {
            position: relative;
            z-index: 10000;
            background: white;
        }

        .main-content {
            display: flex;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .left-panel, .right-panel {
            flex: 1;
            background: white;
            border-radius: 4px;
            padding: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .left-panel {
            position: relative;
        }
        
        #allBadaniaProgress {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .right-panel {
            position: relative;
        }
        
        #paymentProgress {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .panel-title {
            font-size: 24px;
            font-weight: 500;
            margin: 0;
            padding: 24px;
            min-height: 85px;
            box-sizing: border-box;
            color: #212121;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .edit-button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .edit-button:hover {
            background: #1565c0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .edit-button:active {
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 4px;
            padding: 0;
            max-width: 900px;
            width: 90%;
            height: 90vh;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2), 0 16px 32px rgba(0,0,0,0.2);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
            background: white;
        }

        .modal-header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: #212121;
            font-weight: 400;
            font-size: 24px;
        }

        .close-button {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .close-button:hover {
            background: #c62828;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .close-button:active {
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        #editTableContainer {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            padding: 0 20px 24px 24px; /* Większy padding po prawej dla scrollbara */
            scrollbar-gutter: stable; /* Rezerwuje miejsce na scrollbar */
        }

        #editError {
            padding: 16px 24px;
            flex-shrink: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            color: #d32f2f;
        }

        .progress-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: transparent;
            overflow: hidden;
            z-index: 1000;
        }

        .progress-bar {
            height: 100%;
            background: #1976d2;
            width: 30%;
            animation: progress-indeterminate 1.5s ease-in-out infinite;
        }

        @keyframes progress-indeterminate {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(400%);
            }
        }

        .progress-container.hidden {
            display: none;
        }

        .progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.1);
            z-index: 9999;
            pointer-events: all;
            cursor: wait;
        }

        .progress-overlay.hidden {
            display: none;
        }

        .edit-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed;
        }

        .edit-table th,
        .edit-table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            text-align: left;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
        }
        
        .edit-table tbody tr:last-child td {
            border-bottom: none;
        }

        .edit-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .edit-table th {
            background: #1976d2;
            color: white;
            font-weight: 500;
            position: sticky;
            top: 0;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
        }

        /* Szerokości kolumn */
        .edit-table th:nth-child(1),
        .edit-table td:nth-child(1) {
            width: 70px; /* KOD - szerokość 3 znaków + 10px */
        }

        /* Kolumna "Nazwa badania" (2) zajmuje resztę miejsca automatycznie */

        .edit-table th:nth-child(3),
        .edit-table td:nth-child(3) {
            width: 120px; /* Kwota - dwa razy mniejsza */
        }

        .edit-table th:nth-child(4),
        .edit-table td:nth-child(4) {
            width: 120px; /* Kwota 2 - dwa razy mniejsza */
        }

        .edit-table th:nth-child(5),
        .edit-table td:nth-child(5) {
            width: 90px; /* Akcja - szerokość dla przycisku USUŃ */
        }
        
        /* Wyrównanie KOD do prawej - 1. kolumna */
        .edit-table th:nth-child(1),
        .edit-table td:nth-child(1) {
            text-align: right;
        }
        
        /* Wyrównanie Kwota do prawej - 3. kolumna */
        .edit-table th:nth-child(3),
        .edit-table td:nth-child(3) {
            text-align: right;
        }
        
        /* Wyrównanie Kwota 2 do prawej - 4. kolumna */
        .edit-table th:nth-child(4),
        .edit-table td:nth-child(4) {
            text-align: right;
        }
        
        /* Wycentrowanie Akcja - 5. kolumna */
        .edit-table th:nth-child(5),
        .edit-table td:nth-child(5) {
            text-align: center;
        }
        
        /* Wyrównanie inputów w kolumnach KOD, Kwota i Kwota 2 do prawej */
        .edit-table td:nth-child(1) input,
        .edit-table td:nth-child(3) input,
        .edit-table td:nth-child(4) input {
            text-align: right;
        }

        .edit-table input {
            width: 100%;
            padding: 12px;
            border: none;
            border-bottom: 2px solid transparent;
            border-radius: 0;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            box-sizing: border-box;
            background: transparent;
            transition: border-color 0.3s;
        }

        .edit-table input:focus {
            outline: none;
            border-bottom-color: #1976d2;
        }

        .edit-table input.error {
            border-bottom-color: #d32f2f;
        }

        .modal-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .add-row-button {
            background: #388e3c;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .add-row-button:hover {
            background: #2e7d32;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .add-row-button:active {
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .save-button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .save-button:hover {
            background: #1565c0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .save-button:active {
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .delete-row-button {
            background: #d32f2f;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .delete-row-button:hover {
            background: #c62828;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .delete-row-button:active {
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .error-message {
            color: #d32f2f;
            font-size: 12px;
            margin-top: 5px;
        }


        .search-container {
            padding: 24px;
            padding-bottom: 16px;
            flex-shrink: 0;
            background: white;
        }
        
        .left-panel-table-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            padding: 0 24px 24px 24px;
            padding-right: 40px;
            scrollbar-gutter: stable;
        }

        .search-input {
            width: 100%;
            padding: 16px;
            border: none;
            border-bottom: 2px solid #e0e0e0;
            border-radius: 0;
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            margin-bottom: 24px;
            background: transparent;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-bottom-color: #1976d2;
        }

        .results-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .results-table thead {
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
        }

        .results-table th {
            background: #1976d2;
            color: white;
            font-weight: 500;
            position: sticky;
            top: 0;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
        }

        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 25px;
        }

        /* Rozszerz kolumnę KOD, aby ikona sortowania nie zachodziła na tekst */
        #allBadaniaTable th:nth-child(2),
        #allBadaniaTable td:nth-child(2) {
            min-width: 80px;
            padding-right: 30px;
        }

        .sortable-header:hover {
            background: #1565c0;
        }

        .sortable-header::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            opacity: 0.5;
        }

        .sortable-header.sort-asc::after {
            border-bottom: 8px solid white;
            border-top: none;
            opacity: 1;
        }

        .sortable-header.sort-desc::after {
            border-top: 8px solid white;
            border-bottom: none;
            opacity: 1;
        }

        /* Wyrównanie KOD do prawej - 2. kolumna w tabelach (wszystkie badania, wyniki wyszukiwania) */
        #allBadaniaTable th:nth-child(2),
        #allBadaniaTable td:nth-child(2),
        #resultsTable th:nth-child(2),
        #resultsTable td:nth-child(2) {
            text-align: right;
        }

        /* Wyrównanie KWOTA do prawej - 3. kolumna we wszystkich tabelach */
        .results-table th:nth-child(3),
        .results-table td:nth-child(3) {
            text-align: right;
        }
        
        /* Wycentrowanie Akcja - 4. kolumna w tabeli wszystkich badań */
        #allBadaniaTable th:nth-child(4),
        #allBadaniaTable td:nth-child(4) {
            text-align: center;
        }

        /* Wyrównanie KOD do prawej - 1. kolumna w tabeli wybranych */
        #selectedTable th:nth-child(1),
        #selectedTable td:nth-child(1) {
            text-align: right;
        }
        
        /* Wyrównanie Ilość - 4. kolumna w tabeli wybranych */
        #selectedTable th:nth-child(4) {
            text-align: center;
        }
        #selectedTable td:nth-child(4) {
            text-align: right;
        }
        
        /* Wycentrowanie Akcja - 5. kolumna w tabeli wybranych */
        #selectedTable th:nth-child(5),
        #selectedTable td:nth-child(5) {
            text-align: center;
        }
        
        /* Wyrównanie inputu Ilość do prawej */
        #selectedTable td:nth-child(4) input.quantity-input {
            text-align: right;
        }
        
        /* Style dla steppera Ilość - zawsze pokazuj strzałki i kolor granatowy */
        .quantity-input {
            width: 80px;
            padding: 8px;
            text-align: right;
            border: 1px solid #f0f0f0;
            border-radius: 4px;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            color: #212121;
            -webkit-appearance: textfield;
            -moz-appearance: textfield;
            appearance: textfield;
        }
        
        .quantity-input::-webkit-inner-spin-button,
        .quantity-input::-webkit-outer-spin-button {
            opacity: 1;
            height: 20px;
            width: 20px;
            cursor: pointer;
            background-color: #1976d2;
        }
        
        .quantity-input::-webkit-inner-spin-button {
            -webkit-appearance: inner-spin-button;
        }
        
        .quantity-input:focus {
            border-color: #e0e0e0;
            outline: none;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
        }
        
        .quantity-input:hover {
            border-color: #e0e0e0;
        }

        .results-table tr:hover {
            background: #f5f5f5;
        }

        .add-button {
            background: #388e3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s, box-shadow 0.3s;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            text-align: center;
            white-space: nowrap;
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        /* Na desktopie ukryj ikony, pokaż tekst */
        .add-button .material-icons,
        .remove-button .material-icons,
        .save-payment-button .material-icons,
        .remove-all-button .material-icons {
            display: none;
        }

        .add-button .button-text,
        .remove-button .button-text,
        .save-payment-button .button-text,
        .remove-all-button .button-text {
            display: inline;
        }

        .add-button:hover {
            background: #2e7d32;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .add-button:active {
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .add-button:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
            box-shadow: none;
        }



        .remove-button {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .remove-button:hover {
            background: #c62828;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .remove-button:active {
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .selected-table-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            padding: 0 24px 24px 24px;
            padding-right: 40px;
            scrollbar-gutter: stable;
        }
        
        .selected-table-wrapper .results-table {
            margin-top: 16px;
        }
        
        .selected-table-wrapper .results-table thead {
            top: 0;
        }
        
        .selected-table-wrapper .results-table th {
            top: 0;
        }
        
        .selected-table-wrapper .results-table tbody tr td.empty-message {
            padding-top: 20px;
        }

        .suma-wrapper {
            margin-top: auto;
            padding: 24px;
            padding-bottom: 5px;
            flex-shrink: 0;
            background: white;
        }

        /* Kontener dla paneli Suma i Transakcje - przezroczysty na desktop */
        .bottom-panels-wrapper {
            display: contents; /* Na desktopie kontener jest przezroczysty, panele działają normalnie */
        }

        /* Na mobile zmniejsz padding suma-wrapper */
        @media screen and (max-width: 768px) {
            .suma-wrapper {
                margin-top: 0;
                padding-bottom: 6px;
            }

            /* Kontener dla paneli Suma i Transakcje - widoczny jako flex na mobile */
            .bottom-panels-wrapper {
                display: flex;
            }
        }

        .save-payment-button {
            background: #388e3c;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .save-payment-button:hover {
            background: #2e7d32;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .save-payment-button:active {
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .save-payment-button:disabled {
            background: #9e9e9e;
            color: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .save-payment-button:disabled:hover {
            background: #9e9e9e;
            box-shadow: none;
        }

        .remove-all-button {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: background 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .remove-all-button:hover {
            background: #c62828;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .remove-all-button:active {
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .remove-all-button:disabled {
            background: #9e9e9e;
            color: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .remove-all-button:disabled:hover {
            background: #9e9e9e;
            box-shadow: none;
        }

        .suma-container {
            background: #1976d2;
            color: white;
            padding: 24px;
            border-radius: 4px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 4px 8px rgba(0,0,0,0.1);
        }

        .suma-label {
            font-size: 16px;
            margin-bottom: 12px;
            font-weight: 400;
            opacity: 0.9;
        }

        .suma-value {
            font-size: 36px;
            font-weight: 500;
        }

        .stats-wrapper {
            margin-top: 0;
            padding: 5px 24px 24px 24px;
            flex-shrink: 0;
            background: white;
        }

        .stats-container {
            background: #7b1fa2;
            color: white;
            padding: 24px;
            border-radius: 4px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 4px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .stats-progress {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
            overflow: hidden;
            border-radius: 4px 4px 0 0;
        }
        
        .stats-progress-bar {
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            width: 30%;
            animation: progress-indeterminate 1.5s ease-in-out infinite;
        }
        
        .stats-progress.hidden {
            display: none;
        }

        /* Styl dla zaznaczonego wiersza w tabeli transakcji */
        #transactionsMasterBody tr.transaction-row.selected {
            background: #616161 !important;
            color: white !important;
        }

        #transactionsMasterBody tr.transaction-row.selected:hover {
            background: #616161 !important;
            color: white !important;
        }

        .stats-label {
            font-size: 16px;
            margin-bottom: 16px;
            font-weight: 400;
            opacity: 0.9;
        }

        .stats-content {
            display: flex;
            justify-content: space-around;
            gap: 20px;
        }

        .stats-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stats-item-label {
            font-size: 14px;
            opacity: 0.8;
            font-weight: 400;
        }

        .stats-item-value {
            font-size: 24px;
            font-weight: 500;
        }

        .empty-message {
            text-align: center;
            color: #757575;
            padding: 40px;
            font-style: italic;
            font-weight: 300;
        }

        /* Wskaźniki swipe - ukryte na desktop */
        .swipe-indicator {
            display: none;
        }

        /* Responsywne style dla urządzeń mobilnych */
        @media screen and (max-width: 768px) {
            body {
                padding: 0;
                margin: 0;
                overflow-x: hidden;
                overflow-y: auto;
            }

            /* Panel logowania - pełna wysokość i szerokość na mobile */
            .login-container {
                max-width: 100%;
                margin: 0;
                padding: 24px 16px;
                min-height: 100vh;
                min-height: -webkit-fill-available;
                display: flex;
                flex-direction: column;
                justify-content: center;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                z-index: 10000;
                overflow-y: auto;
                background: #f5f5f5;
            }

            /* Upewnij się, że aplikacja jest ukryta gdy panel logowania jest widoczny */
            .login-container:not([style*="display: none"]) ~ .app-container {
                display: none !important;
            }

            .app-container {
                max-width: 100%;
                height: 100vh;
                height: -webkit-fill-available; /* Safari fallback */
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            .main-content {
                flex-direction: row;
                gap: 0;
                height: 100vh;
                height: -webkit-fill-available; /* Safari fallback */
                position: relative;
                overflow: hidden;
                margin: 0;
                padding: 0;
                flex: 1;
                min-height: 0;
            }

            .left-panel, .right-panel {
                flex: none;
                width: 100%;
                height: 100%;
                min-height: 0;
                max-height: 100%;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                position: absolute;
                top: 0;
                left: 0;
                transition: transform 0.3s ease-in-out;
            }

            /* Prawy panel - taka sama wysokość jak lewy panel */
            .right-panel {
                overflow: hidden;
            }

            .right-panel .panel-title {
                flex-shrink: 0;
            }

            .right-panel .selected-table-wrapper {
                flex: 1;
                min-height: 0;
                overflow-y: auto;
                overflow-x: auto;
            }

            /* Panel "Wszystkie badania" domyślnie widoczny */
            .left-panel {
                transform: translateX(0);
                z-index: 1;
            }

            /* Panel "Wybrane badania" ukryty domyślnie */
            .right-panel {
                transform: translateX(100%);
                z-index: 2;
            }

            /* Panel "Wybrane badania" widoczny po swipe */
            .right-panel.active {
                transform: translateX(0);
            }

            /* Panel "Wszystkie badania" ukryty po swipe */
            .left-panel.hidden {
                transform: translateX(-100%);
            }

            .panel-title {
                padding: 10px 12px;
                min-height: auto;
                font-size: 22px;
                flex-wrap: wrap;
                gap: 6px;
            }

            .panel-title span {
                flex: 1;
            }

            /* Nagłówek "Wybrane badania" - przyciski obok tytułu */
            .right-panel .panel-title {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .right-panel .panel-title span {
                margin-bottom: 0;
            }

            /* Ukryj przycisk "Edytuj dane" w lewym panelu na urządzeniach mobilnych */
            .left-panel .edit-button {
                display: none;
            }

            /* Zastąp przyciski ikonami na urządzeniach mobilnych */
            .add-button, .remove-button, .save-payment-button, .remove-all-button {
                padding: 0;
                width: 36px;
                height: 36px;
                min-width: 36px;
                max-width: 36px;
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                overflow: hidden;
            }

            /* Ukryj tekst przycisków na mobile, pokaż ikony */
            .add-button .button-text,
            .remove-button .button-text,
            .save-payment-button .button-text,
            .remove-all-button .button-text {
                display: none !important;
            }

            /* Pokaż ikony Material Icons w przyciskach na mobile */
            .add-button .material-icons,
            .remove-button .material-icons,
            .save-payment-button .material-icons,
            .remove-all-button .material-icons {
                font-size: 22px !important;
                color: white !important;
                line-height: 1;
                display: inline-block !important;
            }

            /* Wskaźniki swipe - tylko na urządzeniach mobilnych */
            .swipe-indicator {
                position: fixed;
                bottom: 10px;
                left: 50%;
                transform: translateX(-50%);
                display: flex;
                gap: 8px;
                z-index: 100;
                pointer-events: none;
            }

            .swipe-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: rgba(0, 0, 0, 0.3);
                transition: background 0.3s;
                cursor: pointer;
            }

            .swipe-dot.active {
                background: #1976d2;
            }

            .panel-title > div {
                display: flex;
                gap: 8px;
                flex-wrap: nowrap;
            }

            .panel-title > div button {
                flex: none;
                min-width: auto;
            }

            /* Przyciski w nagłówku "Wybrane badania" - kwadratowe, obok siebie */
            .right-panel .panel-title > div {
                display: flex;
                gap: 8px;
            }

            .right-panel .save-payment-button,
            .right-panel .remove-all-button {
                width: 36px;
                height: 36px;
                min-width: 36px;
                max-width: 36px;
            }

            .search-container {
                padding: 8px 12px;
            }

            .search-input {
                font-size: 16px;
                padding: 12px;
            }

            .left-panel-table-wrapper, .selected-table-wrapper {
                padding: 0;
                overflow-x: auto;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
            }

            /* Tabela w lewym panelu - rozszerzona do końca ekranu */
            .left-panel-table-wrapper {
                padding: 0;
            }

            .left-panel-table-wrapper table,
            .selected-table-wrapper table {
                width: 100%;
            }

            /* Tabela wybranych badań - tekst "Brak wybranych badań" na górze pod nagłówkiem */
            .selected-table-wrapper .results-table {
                display: table;
            }

            .selected-table-wrapper .results-table tbody tr td.empty-message {
                padding-top: 8px;
                padding-bottom: 0;
            }

            .results-table {
                font-size: 16px;
                width: 100%;
                min-width: 600px;
            }

            .results-table th, .results-table td {
                padding: 10px 8px;
                font-size: 16px;
            }

            /* Ukryj kolumnę "Kwota" w tabeli wszystkich badań na urządzeniach mobilnych */
            #allBadaniaTable th:nth-child(3),
            #allBadaniaTable td:nth-child(3) {
                display: none;
            }

            #allBadaniaTable {
                min-width: 400px;
            }

            /* Tabela wybranych badań - taka sama szerokość jak wszystkie badania */
            #selectedTable {
                min-width: 400px;
                width: 100%;
            }

            /* Ukryj kolumnę "Kwota" w tabeli wybranych badań na urządzeniach mobilnych */
            #selectedTable th:nth-child(3),
            #selectedTable td:nth-child(3) {
                display: none;
            }

            /* Zmniejsz szerokość kolumny "Nazwa badania" w tabeli wybranych badań */
            #selectedTable th:nth-child(2),
            #selectedTable td:nth-child(2) {
                max-width: 150px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            /* Wyśrodkuj przyciski "Usuń" w kolumnie "Akcja" w tabeli wybranych badań */
            #selectedTable th:nth-child(5),
            #selectedTable td:nth-child(5) {
                text-align: center;
            }

            #selectedTable td:nth-child(5) button {
                margin: 0 auto;
            }

            .add-button {
                padding: 5px 8px;
                font-size: 10px;
                width: 50px;
                min-width: 50px;
                max-width: 50px;
            }

            .remove-button {
                padding: 5px 8px;
                font-size: 10px;
            }

            .quantity-input {
                width: 55px;
                padding: 6px;
                font-size: 14px;
            }

            /* Prawy panel - suma i stats na dole */
            .right-panel {
                display: flex;
                flex-direction: column;
            }

            .selected-table-wrapper {
                flex: 1;
                min-height: 0;
            }

            .suma-wrapper {
                padding: 6px 12px;
                margin-top: auto;
                flex-shrink: 0;
            }

            .suma-container {
                padding: 8px;
            }

            .suma-label {
                font-size: 14px;
            }

            .suma-value {
                font-size: 18px;
            }

            /* Kontener dla paneli Suma i Transakcje z dnia */
            .bottom-panels-wrapper {
                margin-top: auto;
                flex-shrink: 0;
                display: flex;
                flex-direction: column;
                gap: 0;
            }

            /* Panel "Suma wybranych badań" */
            .suma-wrapper {
                padding: 10px 12px;
                margin-top: 0;
                flex-shrink: 0;
            }

            .suma-container {
                padding: 12px;
            }

            .suma-label {
                font-size: 18px;
            }

            .suma-value {
                font-size: 22px;
            }

            /* Panel "Transakcje z dnia" */
            .stats-wrapper {
                padding: 10px 12px;
                margin-top: 0;
                flex-shrink: 0;
            }

            .stats-container {
                padding: 12px;
            }

            .stats-label {
                font-size: 16px;
            }

            .stats-item-value {
                font-size: 20px;
            }

            .stats-item-label {
                font-size: 15px;
            }

            .stats-container .material-icons {
                font-size: 20px !important;
            }

            /* Modal na pełnym ekranie na urządzeniach mobilnych */
            .modal-overlay {
                padding: 0;
            }

            .modal-content {
                width: 100vw;
                height: 100vh;
                max-width: 100vw;
                max-height: 100vh;
                border-radius: 0;
                margin: 0;
            }

            .modal-header {
                padding: 10px 12px;
            }

            .modal-header h2 {
                font-size: 16px;
            }

            .close-button, .save-button, .add-row-button {
                padding: 6px 12px;
                font-size: 11px;
            }

            .modal-header-buttons {
                flex-wrap: wrap;
                gap: 8px;
            }

            #editTableContainer {
                padding: 0 6px 10px 6px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .edit-table {
                font-size: 11px;
                min-width: 650px;
            }

            .edit-table th, .edit-table td {
                padding: 6px 4px;
                font-size: 11px;
            }

            .edit-table input {
                font-size: 11px;
                padding: 5px;
            }

            /* Transakcje modal na urządzeniach mobilnych */
            #transactionsModal .modal-content {
                flex-direction: column;
            }

            #transactionsModal .calendar-container {
                padding: 6px;
                flex-shrink: 0;
            }

            #transactionsModal .calendar {
                font-size: 10px;
            }

            #transactionsModal .calendar-day {
                padding: 5px 2px;
                font-size: 9px;
            }

            #transactionsModal .date-picker-container {
                padding: 6px;
                flex-shrink: 0;
            }

            #transactionsModal .date-picker-container input {
                font-size: 13px;
                padding: 8px;
            }

            #transactionsModal .transactions-tables-container {
                flex-direction: column;
                gap: 8px;
                flex: 1;
                min-height: 0;
            }

            #transactionsModal .master-table-container,
            #transactionsModal .detail-table-container {
                flex: 1;
                min-height: 200px;
                max-height: 300px;
                overflow: auto;
                -webkit-overflow-scrolling: touch;
            }

            #transactionsModal .master-table,
            #transactionsModal .detail-table {
                font-size: 11px;
                min-width: 100%;
            }

            #transactionsModal .master-table {
                min-width: 500px;
            }

            #transactionsModal .detail-table {
                min-width: 400px;
            }

            #transactionsModal .master-table th,
            #transactionsModal .master-table td,
            #transactionsModal .detail-table th,
            #transactionsModal .detail-table td {
                padding: 5px 3px;
                font-size: 10px;
            }

            #transactionsModal .day-stats-panel {
                padding: 10px;
                margin-top: 6px;
                flex-shrink: 0;
            }

            #transactionsModal .day-stats-panel > div {
                font-size: 12px;
            }

            .copyright {
                margin-top: 16px;
                padding-top: 12px;
                font-size: 10px;
            }
        }

        /* Style dla bardzo małych ekranów (telefony w orientacji pionowej) */
        @media screen and (max-width: 480px) {
            body {
                padding: 3px;
            }

            .login-container {
                margin: 15px auto;
                padding: 20px 12px;
            }

            .main-content {
                gap: 5px;
            }

            .left-panel, .right-panel {
                height: 100%;
            }

            .panel-title {
                font-size: 20px;
                padding: 8px 10px;
            }

            .panel-title > div button {
                min-width: calc(50% - 4px);
                font-size: 10px;
                padding: 5px 10px;
            }

            .results-table {
                font-size: 15px;
                min-width: 400px;
            }

            .results-table th, .results-table td {
                padding: 8px 6px;
                font-size: 15px;
            }

            #allBadaniaTable {
                min-width: 350px;
            }

            #selectedTable {
                min-width: 350px;
            }

            /* Zmniejsz szerokość kolumny "Nazwa badania" w tabeli wybranych badań na małych ekranach */
            #selectedTable th:nth-child(2),
            #selectedTable td:nth-child(2) {
                max-width: 120px;
            }

            .suma-value {
                font-size: 14px;
            }

            .stats-item-value {
                font-size: 14px;
            }

            .modal-header h2 {
                font-size: 14px;
            }

            .edit-table {
                font-size: 10px;
                min-width: 600px;
            }

            .edit-table th, .edit-table td {
                padding: 5px 3px;
                font-size: 10px;
            }

            #transactionsModal .calendar-day {
                padding: 3px 1px;
                font-size: 8px;
            }

            #transactionsModal .master-table,
            #transactionsModal .detail-table {
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
    <!-- Ekran logowania -->
    <div class="login-container" id="loginContainer">
        <img src="/static/decent-code-1024x0.png" alt="Decent Code Logo" class="login-logo">
        <h1>System Badań Lekarskich</h1>
        <form class="login-form" id="loginForm">
            <input type="password" id="passwordInput" placeholder="Wprowadź hasło" required>
            <button type="submit">Zaloguj</button>
            <div class="error-message" id="errorMessage">Nieprawidłowe hasło</div>
        </form>
        <div class="copyright">
            <p>&copy; 2025–2026 Decent Code sp. z o.o.</p>
            <p>All rights reserved</p>
        </div>
    </div>

    <!-- Główna aplikacja -->
    <div class="app-container" id="appContainer">
        <div class="progress-overlay hidden" id="progressOverlay"></div>
        <div class="main-content" id="mainContent">
            <!-- Lewy panel - wszystkie badania z filtrem -->
            <div class="left-panel">
                <div class="progress-container hidden" id="allBadaniaProgress">
                    <div class="progress-bar"></div>
                </div>
                <div class="panel-title">
                    <span>Wszystkie badania</span>
                    <button class="edit-button" onclick="openEditModal()">Edytuj dane</button>
                </div>
                <div class="search-container">
                    <input type="text" class="search-input" id="searchInput" placeholder="Filtruj badania po nazwie lub kodzie...">
                </div>
                <div class="left-panel-table-wrapper">
                    <table class="results-table" id="allBadaniaTable">
                        <thead>
                            <tr>
                                <th class="sortable-header sort-asc" onclick="sortTable('nazwa')" id="sortNazwa">Nazwa badania</th>
                                <th class="sortable-header" onclick="sortTable('kod')" id="sortKod">Kod</th>
                                <th>Kwota</th>
                                <th>Akcja</th>
                            </tr>
                        </thead>
                        <tbody id="allBadaniaTableBody">
                            <tr>
                                <td colspan="4" class="empty-message">Ładowanie...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Prawy panel - wybrane badania i suma -->
            <div class="right-panel">
                <div class="progress-container hidden" id="paymentProgress">
                    <div class="progress-bar"></div>
                </div>
                <div class="panel-title">
                    <span>Wybrane badania</span>
                    <div style="display: flex; gap: 10px;">
                        <button class="save-payment-button" id="savePaymentButton" onclick="savePayment()" disabled>
                            <span class="material-icons">save</span>
                            <span class="button-text">Zapisz płatność</span>
                        </button>
                        <button class="remove-all-button" id="removeAllButton" onclick="removeAllBadania()" disabled>
                            <span class="material-icons">delete_sweep</span>
                            <span class="button-text">Usuń wszystkie</span>
                        </button>
                    </div>
                </div>
                <div class="selected-table-wrapper">
                    <table class="results-table" id="selectedTable">
                        <thead>
                            <tr>
                                <th>Kod</th>
                                <th>Nazwa badania</th>
                                <th>Kwota</th>
                                <th>Ilość</th>
                                <th>Akcja</th>
                            </tr>
                        </thead>
                        <tbody id="selectedTableBody">
                            <tr>
                                <td colspan="5" class="empty-message">Brak wybranych badań</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="bottom-panels-wrapper">
                    <div class="suma-wrapper">
                        <div class="suma-container">
                            <div class="suma-label">Suma wybranych badań:</div>
                            <div class="suma-value" id="sumaValue">0,00 zł</div>
                        </div>
                    </div>
                    <div class="stats-wrapper">
                        <div class="stats-container">
                        <div class="stats-progress hidden" id="statsProgress">
                            <div class="stats-progress-bar"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div class="stats-label" style="margin: 0;">Transakcje z dnia:</div>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <span class="material-icons" onclick="openTransactionsModal()" style="cursor: pointer; font-size: 24px; opacity: 0.9; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'" title="Dzienne zestawienie transakcji">calendar_today</span>
                                <span class="material-icons" onclick="generateDailyReport()" style="cursor: pointer; font-size: 24px; opacity: 0.9; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'" title="Pobierz raport dzienny (PDF)">print</span>
                                <span class="material-icons" onclick="generateMonthlyReport()" style="cursor: pointer; font-size: 24px; opacity: 0.9; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'" title="Pobierz raport miesięczny (PDF)">description</span>
                            </div>
                        </div>
                        <div class="stats-content">
                            <div class="stats-item">
                                <span class="stats-item-label">Ilość:</span>
                                <span class="stats-item-value" id="statsCount">-</span>
                            </div>
                            <div class="stats-item">
                                <span class="stats-item-label">Suma:</span>
                                <span class="stats-item-value" id="statsSum">-</span>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Wskaźniki swipe (tylko na urządzeniach mobilnych) -->
        <div class="swipe-indicator" id="swipeIndicator">
            <div class="swipe-dot active" data-panel="left"></div>
            <div class="swipe-dot" data-panel="right"></div>
        </div>
    </div>

    <!-- Modal do transakcji -->
    <div class="modal-overlay" id="transactionsModal">
        <div class="modal-content" style="max-width: 1200px; width: 90%; position: relative;">
            <div class="progress-container hidden" id="transactionsProgress">
                <div class="progress-bar"></div>
            </div>
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.7); z-index: 10; display: none;" id="transactionsOverlay"></div>
            <div class="modal-header">
                <h2>Transakcje</h2>
                <button class="close-button" onclick="closeTransactionsModal()">Zamknij</button>
            </div>
            <div style="display: flex; gap: 24px; padding: 24px; height: calc(90vh - 120px);">
                <!-- Lewa strona - kalendarz -->
                <div style="flex: 0 0 350px; display: flex; flex-direction: column;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #212121;">Wybierz datę:</label>
                        <input type="date" id="transactionDatePicker" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Roboto', sans-serif; font-size: 14px;" onchange="handleDatePickerChange()">
                    </div>
                    <div id="calendarContainer" style="background: white; border-radius: 4px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 16px;">
                        <!-- Kalendarz będzie wygenerowany przez JavaScript -->
                    </div>
                    <!-- Pusty panel/spacer -->
                    <div style="flex: 1;"></div>
                    <!-- Panel ze statystykami dnia -->
                    <div style="background: #616161; border-radius: 4px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="color: white; margin-bottom: 12px; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">Ilość transakcji</div>
                            <div style="font-size: 24px; font-weight: 500;" id="dayTransactionCount">-</div>
                        </div>
                        <div style="color: white; text-align: center; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">Suma transakcji</div>
                            <div style="font-size: 24px; font-weight: 500;" id="dayTransactionSum">-</div>
                        </div>
                    </div>
                </div>
                <!-- Prawa strona - master/detail -->
                <div style="flex: 1; display: flex; flex-direction: column; gap: 16px;">
                    <!-- Master - lista transakcji -->
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 500; color: #212121;">Transakcje z wybranego dnia</h3>
                        <div style="flex: 1; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px;">
                            <table class="results-table" style="width: 100%;">
                                <thead style="position: sticky; top: 0; z-index: 5;">
                                    <tr>
                                        <th style="background: #1976d2; color: white; padding: 12px; text-align: center; font-size: 14px; font-family: 'Roboto', sans-serif; width: 50px;">LP</th>
                                        <th style="background: #1976d2; color: white; padding: 12px; text-align: left; font-size: 14px; font-family: 'Roboto', sans-serif;">Data</th>
                                        <th style="background: #1976d2; color: white; padding: 12px; text-align: center; font-size: 14px; font-family: 'Roboto', sans-serif; width: 120px;">Ilość badań</th>
                                        <th style="background: #1976d2; color: white; padding: 12px; text-align: right; font-size: 14px; font-family: 'Roboto', sans-serif;">Kwota</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsMasterBody" style="font-family: 'Roboto', sans-serif; font-size: 14px;">
                                    <tr>
                                        <td colspan="4" style="text-align: center; padding: 24px; color: #757575;">Wybierz datę</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Detail - szczegóły transakcji -->
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 500; color: #212121;">Szczegóły transakcji</h3>
                        <div style="flex: 1; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px;">
                            <table class="results-table" style="width: 100%;">
                                <thead style="position: sticky; top: 0; z-index: 5;">
                                    <tr>
                                        <th style="background: #1976d2; color: white; padding: 12px; text-align: right; font-size: 14px; font-family: 'Roboto', sans-serif;">Kod</th>
                                        <th style="background: #1976d2; color: white; padding: 12px; text-align: left; font-size: 14px; font-family: 'Roboto', sans-serif;">Nazwa badania</th>
                                        <th style="background: #1976d2; color: white; padding: 12px; text-align: center; font-size: 14px; font-family: 'Roboto', sans-serif;">Ilość</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsDetailBody" style="font-family: 'Roboto', sans-serif; font-size: 14px;">
                                    <tr>
                                        <td colspan="3" style="text-align: center; padding: 24px; color: #757575;">Wybierz transakcję</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal do edycji danych -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-content">
            <div class="progress-container hidden" id="editProgress">
                <div class="progress-bar"></div>
            </div>
            <div class="modal-header">
                <h2>Edytuj dane badań</h2>
                <div class="modal-header-buttons">
                    <button class="add-row-button" onclick="addEditRow()">Dodaj wiersz</button>
                    <button class="save-button" onclick="saveEditData()">Zapisz</button>
                    <button class="close-button" onclick="closeEditModal()">Zamknij</button>
                </div>
            </div>
            <div class="edit-filter-container" style="margin-bottom: 12px;">
                <input type="text" class="search-input" id="editFilterInput" placeholder="Filtruj wiersze (kod, nazwa, kwota)...">
            </div>
            <div id="editTableContainer">
                <table class="edit-table" id="editTable">
                    <thead>
                        <tr>
                            <th>KOD</th>
                            <th>Nazwa badania</th>
                            <th>Kwota</th>
                            <th>Kwota 2</th>
                            <th>Akcja</th>
                        </tr>
                    </thead>
                    <tbody id="editTableBody">
                        <!-- Wiersze będą dodane dynamicznie -->
                    </tbody>
                </table>
            </div>
            <div id="editError" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let selectedBadania = [];
        let allBadania = [];
        let filteredBadania = [];
        let currentSort = { column: 'nazwa', direction: 'asc' };

        // Logowanie
        // Obsługa gestów swipe na urządzeniach mobilnych
        let touchStartX = 0;
        let touchEndX = 0;
        let currentPanel = 'left'; // 'left' lub 'right'

        function showPanel(panel) {
            const leftPanel = document.querySelector('.left-panel');
            const rightPanel = document.querySelector('.right-panel');
            const swipeIndicator = document.getElementById('swipeIndicator');
            const dots = swipeIndicator ? swipeIndicator.querySelectorAll('.swipe-dot') : [];

            if (window.innerWidth <= 768) {
                if (panel === 'left') {
                    leftPanel.classList.remove('hidden');
                    rightPanel.classList.remove('active');
                    currentPanel = 'left';
                } else {
                    leftPanel.classList.add('hidden');
                    rightPanel.classList.add('active');
                    currentPanel = 'right';
                }

                // Aktualizuj wskaźniki
                dots.forEach((dot, index) => {
                    if ((panel === 'left' && index === 0) || (panel === 'right' && index === 1)) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
            }
        }

        function handleSwipe() {
            if (window.innerWidth > 768) return; // Tylko na urządzeniach mobilnych

            const swipeDistance = touchEndX - touchStartX;
            const minSwipeDistance = 50; // Minimalna odległość dla uznania gestu jako swipe

            if (Math.abs(swipeDistance) > minSwipeDistance) {
                if (swipeDistance > 0 && currentPanel === 'right') {
                    // Swipe w prawo - pokaż lewy panel
                    showPanel('left');
                } else if (swipeDistance < 0 && currentPanel === 'left') {
                    // Swipe w lewo - pokaż prawy panel
                    showPanel('right');
                }
            }
        }

        // Dodaj event listenery dla gestów swipe
        const mainContent = document.getElementById('mainContent');
        if (mainContent) {
            mainContent.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            mainContent.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });
        }

        // Ukryj wskaźniki swipe na desktop
        function updateSwipeIndicators() {
            const swipeIndicator = document.getElementById('swipeIndicator');
            if (swipeIndicator) {
                if (window.innerWidth <= 768) {
                    swipeIndicator.style.display = 'flex';
                } else {
                    swipeIndicator.style.display = 'none';
                }
            }
        }

        window.addEventListener('resize', updateSwipeIndicators);
        updateSwipeIndicators();

        // Upewnij się, że aplikacja jest ukryta na starcie
        (function() {
            const loginContainer = document.getElementById('loginContainer');
            const appContainer = document.getElementById('appContainer');
            if (loginContainer && appContainer) {
                // Panel logowania powinien być widoczny, aplikacja ukryta
                if (loginContainer.style.display !== 'none') {
                    appContainer.style.display = 'none';
                    appContainer.classList.remove('active');
                }
            }
        })();

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('passwordInput').value;
            const errorMessage = document.getElementById('errorMessage');

            try {
                const response = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // Wymagane dla sesji
                    body: JSON.stringify({ password })
                });

                if (response.ok) {
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('appContainer').classList.add('active');
                    // Przewiń do góry po logowaniu (szczególnie ważne na urządzeniach mobilnych)
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0;
                    document.documentElement.scrollTop = 0;
                    // Upewnij się, że pole wyszukiwania jest widoczne (szczególnie na urządzeniach mobilnych)
                    setTimeout(() => {
                        const searchInput = document.getElementById('searchInput');
                        if (searchInput && window.innerWidth <= 768) {
                            searchInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    }, 100);
                    loadAllBadania();
                    loadDailyStats(); // Załaduj statystyki asynchronicznie
                } else if (response.status === 429) {
                    // Rate limiting
                    errorMessage.textContent = 'Zbyt wiele prób logowania. Spróbuj ponownie za 15 minut.';
                    errorMessage.style.display = 'block';
                } else {
                    errorMessage.style.display = 'block';
                }
            } catch (error) {
                errorMessage.style.display = 'block';
            }
        });

        // Wczytaj wszystkie badania
        async function loadAllBadania() {
            const progressContainer = document.getElementById('allBadaniaProgress');
            const progressOverlay = document.getElementById('progressOverlay');
            try {
                // Pokaż progress i zablokuj interfejs
                if (progressContainer) {
                    progressContainer.classList.remove('hidden');
                }
                if (progressOverlay) {
                    progressOverlay.classList.remove('hidden');
                }
                
                const response = await fetch(`${API_BASE}/api/badania`, {
                    credentials: 'include' // Wymagane dla sesji
                });
                
                if (response.status === 401) {
                    // Sesja wygasła - przekieruj do logowania
                    document.getElementById('loginContainer').style.display = 'block';
                    document.getElementById('appContainer').classList.remove('active');
                    return;
                }
                
                const data = await response.json();
                allBadania = data.badania;
                filteredBadania = allBadania;
                displayAllBadania();
            } catch (error) {
                console.error('Błąd podczas ładowania badań:', error);
            } finally {
                // Ukryj progress i odblokuj interfejs
                if (progressContainer) {
                    progressContainer.classList.add('hidden');
                }
                if (progressOverlay) {
                    progressOverlay.classList.add('hidden');
                }
            }
        }

        // Wczytaj statystyki dzienne asynchronicznie
        async function loadDailyStats() {
            const statsProgress = document.getElementById('statsProgress');
            try {
                // Pokaż progress (bez blokowania UI)
                if (statsProgress) {
                    statsProgress.classList.remove('hidden');
                }
                
                const response = await fetch(`${API_BASE}/api/platnosci/stats`, {
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    document.getElementById('loginContainer').style.display = 'block';
                    document.getElementById('appContainer').classList.remove('active');
                    return;
                }
                
                const data = await response.json();
                
                // Zaktualizuj label z datą i czasem z ostatniej transakcji
                const statsLabel = document.querySelector('.stats-label');
                if (statsLabel) {
                    if (data.latest_date) {
                        statsLabel.textContent = `Transakcje z dnia: ${data.latest_date}`;
                    } else {
                        // Jeśli nie ma transakcji, pokaż dzisiejszą datę
                        const now = new Date();
                        const dateTimeStr = now.toLocaleString('pl-PL', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                        statsLabel.textContent = `Transakcje z dnia: ${dateTimeStr}`;
                    }
                }
                
                document.getElementById('statsCount').textContent = data.count || 0;
                document.getElementById('statsSum').textContent = formatPrice(data.sum || 0) + ' zł';
            } catch (error) {
                console.error('Błąd podczas ładowania statystyk:', error);
                document.getElementById('statsCount').textContent = '-';
                document.getElementById('statsSum').textContent = '-';
            } finally {
                // Ukryj progress
                if (statsProgress) {
                    statsProgress.classList.add('hidden');
                }
            }
        }

        // Wyświetl wszystkie badania (lub przefiltrowane)
        function displayAllBadania() {
            const tbody = document.getElementById('allBadaniaTableBody');
            let badaniaToDisplay = filteredBadania.length > 0 ? [...filteredBadania] : [...allBadania];
            
            // Sortuj badania jeśli jest ustawione sortowanie
            if (currentSort.column) {
                badaniaToDisplay.sort((a, b) => {
                    let aVal, bVal;
                    if (currentSort.column === 'nazwa') {
                        aVal = a.nazwa.toLowerCase();
                        bVal = b.nazwa.toLowerCase();
                    } else if (currentSort.column === 'kod') {
                        // Konwertuj kod na liczbę jeśli to możliwe, w przeciwnym razie porównuj jako string
                        aVal = isNaN(a.kod) ? a.kod.toLowerCase() : parseInt(a.kod);
                        bVal = isNaN(b.kod) ? b.kod.toLowerCase() : parseInt(b.kod);
                    }
                    
                    if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            if (badaniaToDisplay.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-message">Brak badań</td></tr>';
                return;
            }

            tbody.innerHTML = badaniaToDisplay.map((badanie, index) => {
                const isSelected = selectedBadania.some(sb => sb.kod === badanie.kod);
                // Znajdź oryginalny indeks w allBadania dla funkcji addBadanieFromAll
                const originalIndex = allBadania.findIndex(b => b.kod === badanie.kod);
                return `
                    <tr>
                        <td>${badanie.nazwa}</td>
                        <td>${badanie.kod}</td>
                        <td>${formatPrice(badanie.kwota)} zł</td>
                        <td>
                            <button class="add-button" 
                                    onclick="addBadanieFromAll(${originalIndex})" 
                                    ${isSelected ? 'disabled' : ''}>
                                <span class="material-icons">${isSelected ? 'check' : 'add'}</span>
                                <span class="button-text">${isSelected ? 'Dodano' : 'Dodaj'}</span>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Sortuj tabelę
        window.sortTable = function(column) {
            // Jeśli kliknięto tę samą kolumnę, zmień kierunek sortowania
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // Zaktualizuj wizualne wskaźniki sortowania
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });
            
            const headerId = column === 'nazwa' ? 'sortNazwa' : 'sortKod';
            const header = document.getElementById(headerId);
            if (header) {
                header.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
            }
            
            // Odśwież wyświetlanie
            displayAllBadania();
        };

        // Filtrowanie badań
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();

            searchTimeout = setTimeout(() => {
                if (query.length === 0) {
                    filteredBadania = allBadania;
                } else {
                    const q = query.toLowerCase();
                    filteredBadania = allBadania.filter(badanie => {
                        const n = (badanie.nazwa || '').toLowerCase();
                        const k = (badanie.kod ?? '').toString().toLowerCase();
                        return n.includes(q) || k.includes(q);
                    });
                }
                displayAllBadania();
            }, 300);
        });

        document.getElementById('editFilterInput').addEventListener('input', (e) => {
            editFilterQuery = e.target.value;
            renderEditTable();
        });


        // Dodaj badanie do listy z tabeli wszystkich badań
        window.addBadanieFromAll = function(index) {
            const badanie = allBadania[index];
            
            if (badanie && !selectedBadania.some(sb => sb.kod === badanie.kod)) {
                // Dodaj ilość domyślną = 1
                const badanieWithQuantity = { ...badanie, ilosc: 1 };
                selectedBadania.push(badanieWithQuantity);
                updateSelectedList();
                updateSuma();
                // Odśwież listę wszystkich badań, aby pokazać stan "Dodano"
                displayAllBadania();
                
                // NIE przełączaj automatycznie do panelu "Wybrane badania" na urządzeniach mobilnych
            }
        };

        // Usuń badanie z listy
        window.removeBadanie = function(kod) {
            selectedBadania = selectedBadania.filter(b => b.kod !== kod);
            updateSelectedList();
            updateSuma();
            // Odśwież listę wszystkich badań
            displayAllBadania();
        };

        // Usuń wszystkie badania z listy
        window.removeAllBadania = function() {
            if (confirm('Czy na pewno chcesz usunąć wszystkie wybrane badania?')) {
                selectedBadania = [];
                updateSelectedList();
                updateSuma();
                // Odśwież listę wszystkich badań
                displayAllBadania();
            }
        };

        // Aktualizuj listę wybranych badań
        function updateSelectedList() {
            const tbody = document.getElementById('selectedTableBody');
            const removeAllButton = document.getElementById('removeAllButton');
            const savePaymentButton = document.getElementById('savePaymentButton');
            const rightPanel = document.querySelector('.right-panel');
            
            // Zawsze pokazuj przyciski, ale blokuj je jeśli nie ma danych
            const hasData = selectedBadania.length > 0;
            if (removeAllButton) {
                removeAllButton.disabled = !hasData;
            }
            if (savePaymentButton) {
                savePaymentButton.disabled = !hasData;
            }
            
            // Automatyczne rozszerzanie prawego panelu na urządzeniach mobilnych gdy są wybrane badania
            if (rightPanel && window.innerWidth <= 768) {
                if (hasData) {
                    rightPanel.style.maxHeight = '70vh';
                } else {
                    rightPanel.style.maxHeight = '50vh';
                }
            }
            
            if (selectedBadania.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-message">Brak wybranych badań</td></tr>';
                return;
            }

            tbody.innerHTML = selectedBadania.map((badanie, index) => `
                <tr>
                    <td>${badanie.kod}</td>
                    <td>${badanie.nazwa}</td>
                    <td>${formatPrice(badanie.kwota)} zł</td>
                    <td>
                        <input type="number" 
                               class="quantity-input" 
                               value="${badanie.ilosc || 1}" 
                               min="1" 
                               max="999"
                               onchange="updateQuantity(${index}, this.value)">
                    </td>
                    <td>
                        <button class="remove-button" onclick="removeBadanie('${badanie.kod}')">
                            <span class="material-icons">delete</span>
                            <span class="button-text">Usuń</span>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        window.updateQuantity = function(index, newQuantity) {
            let quantity = parseInt(newQuantity) || 1;
            if (quantity < 1) {
                quantity = 1;
            }
            if (selectedBadania[index]) {
                selectedBadania[index].ilosc = quantity;
                updateSelectedList();
                updateSuma();
            }
        }

        // Aktualizuj sumę
        function updateSuma() {
            const suma = selectedBadania.reduce((sum, badanie) => {
                const ilosc = badanie.ilosc || 1;
                return sum + (badanie.kwota * ilosc);
            }, 0);
            document.getElementById('sumaValue').textContent = formatPrice(suma) + ' zł';
        }

        // Formatuj cenę
        function formatPrice(price) {
            return price.toFixed(2).replace('.', ',');
        }

        // Zapisz płatność
        window.savePayment = async function() {
            if (selectedBadania.length === 0) {
                alert('Brak badań do zapisania');
                return;
            }

            // Oblicz sumę (kwota * ilość)
            const suma = selectedBadania.reduce((sum, badanie) => {
                const ilosc = badanie.ilosc || 1;
                return sum + (badanie.kwota * ilosc);
            }, 0);
            
            // Pobierz kody badań z ilością oddzielone znakiem |
            const kody = selectedBadania.map(b => {
                const ilosc = b.ilosc || 1;
                if (ilosc > 1) {
                    return `${b.kod}x${ilosc}`;
                }
                return b.kod;
            }).join('|');
            
            // Generuj UID (użyj timestamp + losowy string)
            const uid = Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
            
            // Pobierz datę i godzinę w formacie polskim
            const now = new Date();
            const dateStr = now.toLocaleString('pl-PL', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            const progressContainer = document.getElementById('paymentProgress');
            const progressOverlay = document.getElementById('progressOverlay');
            try {
                // Pokaż progress i zablokuj interfejs
                if (progressContainer) {
                    progressContainer.classList.remove('hidden');
                }
                if (progressOverlay) {
                    progressOverlay.classList.remove('hidden');
                }
                
                const response = await fetch(`${API_BASE}/api/platnosci/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        uid: uid,
                        data: dateStr,
                        badania: kody,
                        kwota: suma,
                        uwagi: ''
                    })
                });

                if (response.ok) {
                    alert('Płatność została zapisana pomyślnie!');
                    // Wyczyść tabelę wybranych badań
                    selectedBadania = [];
                    updateSelectedList();
                    updateSuma();
                    // Odśwież listę wszystkich badań
                    displayAllBadania();
                    // Odśwież statystyki dzienne
                    loadDailyStats();
                } else {
                    const error = await response.json();
                    alert('Błąd podczas zapisu płatności: ' + (error.detail || 'Nieznany błąd'));
                }
            } catch (error) {
                alert('Błąd podczas zapisu płatności: ' + error.message);
            } finally {
                // Ukryj progress i odblokuj interfejs
                const progressContainer = document.getElementById('paymentProgress');
                const progressOverlay = document.getElementById('progressOverlay');
                if (progressContainer) {
                    progressContainer.classList.add('hidden');
                }
                if (progressOverlay) {
                    progressOverlay.classList.add('hidden');
                }
            }
        }

        // Funkcje do edycji danych
        let editData = [];
        let editFilterQuery = '';
        let allBadaniaBeforeEdit = []; // Zapamiętaj dane przed edycją

        function openEditModal() {
            // Zapamiętaj aktualne dane przed edycją
            allBadaniaBeforeEdit = JSON.parse(JSON.stringify(allBadania));
            
            document.getElementById('editModal').classList.add('active');
            // Ustaw maksymalną wysokość modala
            const modalContent = document.querySelector('.modal-content');
            if (modalContent) {
                modalContent.style.height = '90vh';
            }
            // Wyczyść filtr edycji
            editFilterQuery = '';
            const editFilterEl = document.getElementById('editFilterInput');
            if (editFilterEl) editFilterEl.value = '';
            // Wyczyść dane i tabelę przed załadowaniem nowych
            editData = [];
            const tbody = document.getElementById('editTableBody');
            if (tbody) {
                tbody.innerHTML = '';
            }
            const errorDiv = document.getElementById('editError');
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
            loadEditData();
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('editError').style.display = 'none';
            
            // Jeśli są wybrane badania, zaktualizuj je po edycji
            if (selectedBadania.length > 0) {
                updateSelectedBadaniaAfterEdit();
            }
        }
        
        function updateSelectedBadaniaAfterEdit() {
            // Zaktualizuj dane w selectedBadania na podstawie aktualnych danych z allBadania
            let updated = false;
            
            selectedBadania.forEach(selectedBadanie => {
                // Znajdź odpowiadające badanie w allBadania po kodzie
                const updatedBadanie = allBadania.find(b => b.kod === selectedBadanie.kod);
                
                if (updatedBadanie) {
                    // Sprawdź czy nazwa lub kwota się zmieniły
                    if (updatedBadanie.nazwa !== selectedBadanie.nazwa || 
                        updatedBadanie.kwota !== selectedBadanie.kwota) {
                        // Zaktualizuj dane (zachowaj ilość)
                        const ilosc = selectedBadanie.ilosc || 1;
                        selectedBadanie.nazwa = updatedBadanie.nazwa;
                        selectedBadanie.kwota = updatedBadanie.kwota;
                        selectedBadanie.ilosc = ilosc;
                        updated = true;
                    }
                }
            });
            
            // Jeśli były zmiany, zaktualizuj wyświetlanie
            if (updated) {
                updateSelectedList();
                updateSuma();
            }
        }

        async function loadEditData() {
            const progressContainer = document.getElementById('editProgress');
            const progressOverlay = document.getElementById('progressOverlay');
            try {
                // Pokaż progress i zablokuj interfejs
                if (progressContainer) {
                    progressContainer.classList.remove('hidden');
                }
                if (progressOverlay) {
                    progressOverlay.classList.remove('hidden');
                }
                
                const response = await fetch(`${API_BASE}/api/badania/edit`, {
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    document.getElementById('loginContainer').style.display = 'block';
                    document.getElementById('appContainer').classList.remove('active');
                    return;
                }
                
                const data = await response.json();
                editData = data.badania;
                renderEditTable();
            } catch (error) {
                showEditError('Błąd podczas ładowania danych: ' + error.message);
            } finally {
                // Ukryj progress i odblokuj interfejs
                const progressContainer = document.getElementById('editProgress');
                const progressOverlay = document.getElementById('progressOverlay');
                if (progressContainer) {
                    progressContainer.classList.add('hidden');
                }
                if (progressOverlay) {
                    progressOverlay.classList.add('hidden');
                }
            }
        }

        function renderEditTable() {
            const tbody = document.getElementById('editTableBody');
            const q = (editFilterQuery || '').trim().toLowerCase();
            const rowsToShow = q === ''
                ? editData.map((row, index) => ({ row, index }))
                : editData.map((row, index) => ({ row, index })).filter(({ row }) => {
                    const kod = (row.KOD || '').toLowerCase();
                    const nazwa = (row.NAZWA_BADANIA || '').toLowerCase();
                    const kwota = (row.KWOTA || '').toLowerCase();
                    const kwota2 = (row.KWOTA_2 || '').toLowerCase();
                    return kod.includes(q) || nazwa.includes(q) || kwota.includes(q) || kwota2.includes(q);
                });
            tbody.innerHTML = rowsToShow.map(({ row, index }) => `
                <tr data-index="${index}">
                    <td>
                        <input type="text" 
                               value="${(row.KOD || '').replace(/"/g, '&quot;')}" 
                               onchange="updateEditData(${index}, 'KOD', this.value)"
                               class="kod-input"
                               data-index="${index}">
                    </td>
                    <td>
                        <input type="text" 
                               value="${(row.NAZWA_BADANIA || '').replace(/"/g, '&quot;')}" 
                               onchange="updateEditData(${index}, 'NAZWA_BADANIA', this.value)"
                               data-index="${index}">
                    </td>
                    <td>
                        <input type="text" 
                               value="${(row.KWOTA || '').replace(/"/g, '&quot;')}" 
                               onchange="updateEditData(${index}, 'KWOTA', this.value)"
                               data-index="${index}">
                    </td>
                    <td>
                        <input type="text" 
                               value="${(row.KWOTA_2 || '').replace(/"/g, '&quot;')}" 
                               onchange="updateEditData(${index}, 'KWOTA_2', this.value)"
                               data-index="${index}">
                    </td>
                    <td>
                        <button class="delete-row-button" onclick="deleteEditRow(${index})">Usuń</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateEditData(index, field, value) {
            if (editData[index]) {
                editData[index][field] = value;
                validateRow(index);
            }
        }

        function addEditRow() {
            editData.push({
                KOD: '',
                NAZWA_BADANIA: '',
                KWOTA: '',
                KWOTA_2: ''
            });
            renderEditTable();
            // Przewiń do ostatniego wiersza
            const container = document.getElementById('editTableContainer');
            const lastRow = document.querySelector('#editTableBody tr:last-child');
            if (container && lastRow) {
                setTimeout(() => {
                    lastRow.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    // Ustaw focus na pierwszym polu nowego wiersza
                    const firstInput = lastRow.querySelector('input');
                    if (firstInput) {
                        firstInput.focus();
                    }
                }, 100);
            }
        }

        function deleteEditRow(index) {
            if (confirm('Czy na pewno chcesz usunąć ten wiersz?')) {
                editData.splice(index, 1);
                renderEditTable();
            }
        }

        function validateRow(index) {
            const row = editData[index];
            const rowElement = document.querySelector(`tr[data-index="${index}"]`);
            const inputs = rowElement.querySelectorAll('input');
            
            // Reset błędów
            inputs.forEach(input => input.classList.remove('error'));
            
            // Walidacja KOD
            const kodInput = rowElement.querySelector('.kod-input');
            if (kodInput) {
                const kod = kodInput.value.trim();
                if (kod) {
                    if (isNaN(kod) || parseInt(kod) < 0) {
                        kodInput.classList.add('error');
                    } else {
                        // Sprawdź unikalność
                        const duplicates = editData.filter((r, i) => i !== index && r.KOD === kod);
                        if (duplicates.length > 0) {
                            kodInput.classList.add('error');
                        }
                    }
                }
            }
            
            // Walidacja Nazwa badania
            const nazwaInput = inputs[1];
            if (nazwaInput && nazwaInput.value.includes('\n')) {
                nazwaInput.classList.add('error');
            }
            
            // Walidacja Kwota
            const kwotaInput = inputs[2];
            if (kwotaInput && kwotaInput.value.trim()) {
                const kwotaStr = kwotaInput.value.trim().replace(',', '.');
                const kwota = parseFloat(kwotaStr);
                if (isNaN(kwota) || kwota < 0 || kwota > 10000) {
                    kwotaInput.classList.add('error');
                }
            }
        }

        async function saveEditData() {
            // Walidacja wszystkich wierszy
            let hasErrors = false;
            editData.forEach((row, index) => {
                validateRow(index);
                const rowElement = document.querySelector(`tr[data-index="${index}"]`);
                if (rowElement && rowElement.querySelectorAll('input.error').length > 0) {
                    hasErrors = true;
                }
            });

            if (hasErrors) {
                showEditError('Proszę poprawić błędy w danych przed zapisem');
                return;
            }

            // Walidacja unikalności KOD
            const kody = editData.map(r => r.KOD).filter(k => k);
            if (kody.length !== new Set(kody).size) {
                showEditError('KOD musi być unikalny dla każdego badania');
                return;
            }

            // Pytaj o potwierdzenie zapisu
            if (!confirm('Czy na pewno chcesz zapisać dane?')) {
                return;
            }

            const progressContainer = document.getElementById('editProgress');
            const progressOverlay = document.getElementById('progressOverlay');
            try {
                // Pokaż progress i zablokuj interfejs
                if (progressContainer) {
                    progressContainer.classList.remove('hidden');
                }
                if (progressOverlay) {
                    progressOverlay.classList.remove('hidden');
                }
                
                const response = await fetch(`${API_BASE}/api/badania/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ badania: editData })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Dane zostały zapisane pomyślnie!');
                    // Odśwież dane przed zamknięciem modala
                    await loadAllBadania();
                    closeEditModal();
                } else {
                    let errorMessage = 'Błąd podczas zapisu';
                    try {
                        const error = await response.json();
                        errorMessage = error.detail || errorMessage;
                        // Jeśli to błąd walidacji Pydantic, pokaż szczegóły
                        if (error.detail && Array.isArray(error.detail)) {
                            const validationErrors = error.detail.map(e => {
                                const field = e.loc ? e.loc.join('.') : '';
                                return `${field}: ${e.msg}`;
                            }).join('\n');
                            errorMessage = 'Błędy walidacji:\n' + validationErrors;
                        }
                    } catch (e) {
                        errorMessage = `Błąd ${response.status}: ${response.statusText}`;
                    }
                    showEditError(errorMessage);
                }
            } catch (error) {
                showEditError('Błąd podczas zapisu: ' + error.message);
            } finally {
                // Ukryj progress i odblokuj interfejs
                const progressContainer = document.getElementById('editProgress');
                const progressOverlay = document.getElementById('progressOverlay');
                if (progressContainer) {
                    progressContainer.classList.add('hidden');
                }
                if (progressOverlay) {
                    progressOverlay.classList.add('hidden');
                }
            }
        }

        function showEditError(message) {
            const errorDiv = document.getElementById('editError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Zamknij modal przy kliknięciu poza nim
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // Funkcje dla modala transakcji
        let selectedTransactionDate = null;
        let transactionsForDate = [];
        let selectedTransactionIndex = -1; // -1 oznacza brak zaznaczenia
        let currentCalendarYear = null;
        let currentCalendarMonth = null;

        function openTransactionsModal() {
            document.getElementById('transactionsModal').classList.add('active');
            // Ustaw dzisiejszą datę
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('transactionDatePicker').value = todayStr;
            selectedTransactionDate = todayStr;
            // Resetuj zaznaczenie przy otwarciu
            selectedTransactionIndex = -1;
            // Wygeneruj kalendarz
            generateCalendar(today.getFullYear(), today.getMonth());
            // Załaduj transakcje z progressem
            loadTransactionsForDate();
        }

        function closeTransactionsModal() {
            document.getElementById('transactionsModal').classList.remove('active');
        }

        function generateCalendar(year, month) {
            // Zapamiętaj aktualnie wyświetlany miesiąc
            currentCalendarYear = year;
            currentCalendarMonth = month;
            
            const container = document.getElementById('calendarContainer');
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const isToday = (day) => {
                return today.getFullYear() === year && 
                       today.getMonth() === month && 
                       today.getDate() === day;
            };
            const isSelected = (day) => {
                if (!selectedTransactionDate) return false;
                const selected = new Date(selectedTransactionDate);
                return selected.getFullYear() === year && 
                       selected.getMonth() === month && 
                       selected.getDate() === day;
            };

            const monthNames = ['Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec', 
                              'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'];
            const dayNames = ['Nd', 'Pn', 'Wt', 'Śr', 'Cz', 'Pt', 'Sb'];

            let html = `
                <div style="text-align: center; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <button onclick="changeMonth(-1)" style="background: none; border: none; cursor: pointer; padding: 4px 8px; color: #1976d2;">‹</button>
                        <h3 style="margin: 0; font-size: 18px; font-weight: 500;">${monthNames[month]} ${year}</h3>
                        <button onclick="changeMonth(1)" style="background: none; border: none; cursor: pointer; padding: 4px 8px; color: #1976d2;">›</button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
            `;

            // Nagłówki dni
            dayNames.forEach(day => {
                html += `<div style="text-align: center; padding: 8px; font-weight: 500; font-size: 12px; color: #757575;">${day}</div>`;
            });

            // Puste komórki przed pierwszym dniem
            for (let i = 0; i < firstDay; i++) {
                html += `<div></div>`;
            }

            // Dni miesiąca
            for (let day = 1; day <= daysInMonth; day++) {
                const isTodayDay = isToday(day);
                const isSelectedDay = isSelected(day);
                const dayClass = isTodayDay ? 'background: #1976d2; color: white;' : 
                                isSelectedDay ? 'background: #616161; color: white;' : 
                                'background: #f5f5f5; color: #212121;';
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                html += `
                    <div onclick="selectDate('${dateStr}')" 
                         data-is-today="${isTodayDay}"
                         data-is-selected="${isSelectedDay}"
                         style="${dayClass} text-align: center; padding: 12px; border-radius: 4px; cursor: pointer; transition: all 0.2s; font-size: 14px;"
                         onmouseover="if(this.dataset.isToday !== 'true' && this.dataset.isSelected !== 'true') this.style.background='#e0e0e0'"
                         onmouseout="if(this.dataset.isToday === 'true') { this.style.background='#1976d2'; this.style.color='white'; } else if(this.dataset.isSelected === 'true') { this.style.background='#616161'; this.style.color='white'; } else { this.style.background='#f5f5f5'; this.style.color='#212121'; }">
                        ${day}
                    </div>
                `;
            }

            html += `</div></div>`;
            container.innerHTML = html;
        }

        window.changeMonth = function(delta) {
            // Użyj aktualnie wyświetlanego miesiąca zamiast daty z date pickera
            let year = currentCalendarYear !== null ? currentCalendarYear : new Date().getFullYear();
            let month = currentCalendarMonth !== null ? currentCalendarMonth : new Date().getMonth();
            
            const newDate = new Date(year, month, 1);
            newDate.setMonth(newDate.getMonth() + delta);
            generateCalendar(newDate.getFullYear(), newDate.getMonth());
        };

        window.selectDate = function(dateStr) {
            selectedTransactionDate = dateStr;
            document.getElementById('transactionDatePicker').value = dateStr;
            const date = new Date(dateStr);
            generateCalendar(date.getFullYear(), date.getMonth());
            // Resetuj zaznaczenie przy zmianie daty
            selectedTransactionIndex = -1;
            loadTransactionsForDate();
        };

        function handleDatePickerChange() {
            const datePicker = document.getElementById('transactionDatePicker');
            const dateStr = datePicker.value;
            if (dateStr) {
                selectedTransactionDate = dateStr;
                // Zaktualizuj widok kalendarza do miesiąca wybranej daty
                const date = new Date(dateStr);
                generateCalendar(date.getFullYear(), date.getMonth());
                // Resetuj zaznaczenie przy zmianie daty
                selectedTransactionIndex = -1;
                loadTransactionsForDate();
            }
        }

        async function loadTransactionsForDate() {
            if (!selectedTransactionDate) return;

            const progressContainer = document.getElementById('transactionsProgress');
            const overlay = document.getElementById('transactionsOverlay');
            
            try {
                // Pokaż progress i zablokuj UI
                if (progressContainer) {
                    progressContainer.classList.remove('hidden');
                }
                if (overlay) {
                    overlay.style.display = 'block';
                }

                // Wyślij datę w formacie YYYY-MM-DD (z date pickera)
                const response = await fetch(`${API_BASE}/api/platnosci/by-date?date=${selectedTransactionDate}`, {
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    document.getElementById('loginContainer').style.display = 'block';
                    document.getElementById('appContainer').classList.remove('active');
                    return;
                }
                
                const data = await response.json();
                transactionsForDate = data.transactions || [];
                
                // Sortuj po dacie i godzinie
                transactionsForDate.sort((a, b) => {
                    const dateA = a.DATA || '';
                    const dateB = b.DATA || '';
                    return dateB.localeCompare(dateA); // Od najnowszych
                });

                // Oblicz sumę transakcji
                let suma = 0;
                transactionsForDate.forEach(transaction => {
                    const kwotaStr = (transaction.KWOTA || '0').replace(',', '.');
                    try {
                        suma += parseFloat(kwotaStr);
                    } catch (e) {
                        console.error('Błąd parsowania kwoty:', kwotaStr);
                    }
                });

                // Zaktualizuj panel ze statystykami
                document.getElementById('dayTransactionCount').textContent = transactionsForDate.length;
                document.getElementById('dayTransactionSum').textContent = formatPrice(suma) + ' zł';

                // Funkcja pomocnicza do obliczenia liczby pozycji w transakcji
                const getTransactionItemCount = (transaction) => {
                    const badaniaStr = transaction.BADANIA || '';
                    const badaniaItems = badaniaStr.split('|').filter(item => item.trim());
                    return badaniaItems.length;
                };

                // Wyświetl w tabeli master
                const masterBody = document.getElementById('transactionsMasterBody');
                if (transactionsForDate.length === 0) {
                    masterBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 24px; color: #757575;">Brak transakcji w wybranym dniu</td></tr>';
                    document.getElementById('transactionsDetailBody').innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 24px; color: #757575;">Brak transakcji</td></tr>';
                    selectedTransactionIndex = -1;
                } else {
                    // Jeśli nie ma zaznaczenia, wybierz pierwszą transakcję
                    if (selectedTransactionIndex === -1 && transactionsForDate.length > 0) {
                        selectedTransactionIndex = 0;
                    }
                    
                    masterBody.innerHTML = transactionsForDate.map((transaction, index) => {
                        const isSelected = index === selectedTransactionIndex;
                        const itemCount = getTransactionItemCount(transaction);
                        return `
                        <tr onclick="selectTransaction(${index})" 
                            data-index="${index}"
                            class="transaction-row ${isSelected ? 'selected' : ''}"
                            style="cursor: pointer; border-bottom: 1px solid #e0e0e0; ${!isSelected ? 'background: white; color: #212121;' : ''}"
                            onmouseover="if(!this.classList.contains('selected')) this.style.background='#f5f5f5'"
                            onmouseout="if(!this.classList.contains('selected')) { this.style.background='white'; this.style.color='#212121'; }">
                            <td style="padding: 12px; text-align: center;">${index + 1}</td>
                            <td style="padding: 12px;">${transaction.DATA || ''}</td>
                            <td style="padding: 12px; text-align: center;">${itemCount}</td>
                            <td style="padding: 12px; text-align: right;">${formatPrice(parseFloat((transaction.KWOTA || '0').replace(',', '.')))} zł</td>
                        </tr>
                    `;
                    }).join('');

                    // Jeśli jest zaznaczenie, wyświetl szczegóły
                    if (selectedTransactionIndex >= 0 && selectedTransactionIndex < transactionsForDate.length) {
                        selectTransaction(selectedTransactionIndex);
                    } else {
                        // Wyczyść detail jeśli nie ma zaznaczenia
                        document.getElementById('transactionsDetailBody').innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 24px; color: #757575;">Wybierz transakcję</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Błąd podczas ładowania transakcji:', error);
            } finally {
                // Ukryj progress i odblokuj UI
                if (progressContainer) {
                    progressContainer.classList.add('hidden');
                }
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }
        }

        window.selectTransaction = function(index) {
            if (index < 0 || index >= transactionsForDate.length) return;
            
            const previousIndex = selectedTransactionIndex;
            selectedTransactionIndex = index;
            const transaction = transactionsForDate[index];
            if (!transaction) return;

            // Zdekoduj BADANIA
            const badaniaStr = transaction.BADANIA || '';
            const badaniaItems = badaniaStr.split('|').filter(item => item.trim());
            
            const decodedBadania = [];
            badaniaItems.forEach(item => {
                const trimmed = item.trim();
                if (trimmed.includes('x')) {
                    const [kod, ilosc] = trimmed.split('x');
                    decodedBadania.push({
                        kod: kod.trim(),
                        ilosc: parseInt(ilosc.trim()) || 1
                    });
                } else {
                    decodedBadania.push({
                        kod: trimmed,
                        ilosc: 1
                    });
                }
            });

            // Znajdź nazwy badań
            const detailItems = decodedBadania.map(item => {
                const badanie = allBadania.find(b => b.kod === item.kod);
                return {
                    kod: item.kod,
                    nazwa: badanie ? badanie.nazwa : 'Nieznane badanie',
                    ilosc: item.ilosc
                };
            });

            // Wyświetl w tabeli detail
            const detailBody = document.getElementById('transactionsDetailBody');
            if (detailItems.length === 0) {
                detailBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 24px; color: #757575;">Brak badań w transakcji</td></tr>';
            } else {
                detailBody.innerHTML = detailItems.map(item => `
                    <tr style="border-bottom: 1px solid #e0e0e0;">
                        <td style="padding: 12px; text-align: right;">${item.kod}</td>
                        <td style="padding: 12px;">${item.nazwa}</td>
                        <td style="padding: 12px; text-align: center;">${item.ilosc}</td>
                    </tr>
                `).join('');
            }

            // Zaktualizuj podświetlenie w master - odznacz poprzedni, zaznacz nowy
            const masterRows = document.querySelectorAll('#transactionsMasterBody tr.transaction-row');
            masterRows.forEach((row, i) => {
                if (i === index) {
                    // Zaznacz nowy wiersz
                    row.classList.add('selected');
                    // Usuń inline style, aby CSS miał priorytet
                    row.style.background = '';
                    row.style.color = '';
                } else {
                    // Odznacz wszystkie inne wiersze
                    row.classList.remove('selected');
                    // Przywróć domyślny stan
                    row.style.background = 'white';
                    row.style.color = '#212121';
                }
            });
        };

        // Zamknij modal transakcji przy kliknięciu poza nim
        document.getElementById('transactionsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTransactionsModal();
            }
        });

        // Funkcja do generowania raportu dziennego PDF
        async function generateDailyReport() {
            const progressOverlay = document.getElementById('progressOverlay');
            const statsProgress = document.getElementById('statsProgress');
            
            try {
                // Pokaż progress
                if (progressOverlay) {
                    progressOverlay.classList.remove('hidden');
                }
                if (statsProgress) {
                    statsProgress.classList.remove('hidden');
                }
                
                // Pobierz aktualną datę z panelu lub użyj dzisiejszej daty
                const statsLabel = document.querySelector('.stats-label');
                let reportDate = new Date();
                
                // Spróbuj wyciągnąć datę z labela "Transakcje z dnia: DD.MM.YYYY, HH:MM:SS"
                const labelText = statsLabel ? statsLabel.textContent : '';
                if (labelText.includes('Transakcje z dnia:')) {
                    const dateMatch = labelText.match(/(\d{2}\.\d{2}\.\d{4})/);
                    if (dateMatch) {
                        const [day, month, year] = dateMatch[1].split('.');
                        reportDate = new Date(year, month - 1, day);
                    }
                }
                
                const dateStr = `${String(reportDate.getDate()).padStart(2, '0')}.${String(reportDate.getMonth() + 1).padStart(2, '0')}.${reportDate.getFullYear()}`;
                const dateStrForAPI = `${reportDate.getFullYear()}-${String(reportDate.getMonth() + 1).padStart(2, '0')}-${String(reportDate.getDate()).padStart(2, '0')}`;
                
                // Pobierz transakcje z wybranego dnia
                const response = await fetch(`${API_BASE}/api/platnosci/by-date?date=${dateStrForAPI}`, {
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    document.getElementById('loginContainer').style.display = 'block';
                    document.getElementById('appContainer').classList.remove('active');
                    return;
                }
                
                const data = await response.json();
                const transactions = data.transactions || [];
                
                if (transactions.length === 0) {
                    alert('Brak transakcji do wygenerowania raportu dla wybranego dnia.');
                    // Ukryj progress
                    if (progressOverlay) {
                        progressOverlay.classList.add('hidden');
                    }
                    if (statsProgress) {
                        statsProgress.classList.add('hidden');
                    }
                    return;
                }
                
                // Oblicz sumę
                let suma = 0;
                transactions.forEach(transaction => {
                    const kwotaStr = (transaction.KWOTA || '0').replace(',', '.');
                    try {
                        suma += parseFloat(kwotaStr);
                    } catch (e) {
                        console.error('Błąd parsowania kwoty:', kwotaStr);
                    }
                });
                
                // Załaduj bibliotekę jsPDF dynamicznie
                if (typeof window.jsPDF === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    script.onload = async () => {
                        await loadFontForPDF();
                        generatePDF(transactions, suma, dateStr);
                        // Ukryj progress
                        if (progressOverlay) {
                            progressOverlay.classList.add('hidden');
                        }
                        if (statsProgress) {
                            statsProgress.classList.add('hidden');
                        }
                    };
                    document.head.appendChild(script);
                } else {
                    await loadFontForPDF();
                    generatePDF(transactions, suma, dateStr);
                    // Ukryj progress
                    if (progressOverlay) {
                        progressOverlay.classList.add('hidden');
                    }
                    if (statsProgress) {
                        statsProgress.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Błąd podczas generowania raportu:', error);
                alert('Wystąpił błąd podczas generowania raportu.');
                // Ukryj progress w przypadku błędu
                if (progressOverlay) {
                    progressOverlay.classList.add('hidden');
                }
                if (statsProgress) {
                    statsProgress.classList.add('hidden');
                }
            }
        }

        // Funkcja do ładowania czcionki z polskimi znakami
        async function loadFontForPDF() {
            if (window.pdfFontLoaded) return;
            
            try {
                // jsPDF domyślnie obsługuje UTF-8, ale może wymagać specjalnego kodowania
                // Użyjemy standardowej czcionki Helvetica z UTF-8
                window.pdfFontLoaded = true;
            } catch (error) {
                console.error('Błąd podczas ładowania czcionki:', error);
            }
        }

        function generatePDF(transactions, suma, dateStr) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Użyj czcionki Helvetica (najbliższa Arial w jsPDF)
            doc.setFont('helvetica');
            
            // Funkcja pomocnicza do bezpiecznego wyświetlania tekstu z polskimi znakami
            const safeText = (text) => {
                // Zamień polskie znaki na bezpieczne odpowiedniki lub użyj UTF-8
                return text
                    .replace(/ł/g, 'l')
                    .replace(/Ł/g, 'L')
                    .replace(/ą/g, 'a')
                    .replace(/ć/g, 'c')
                    .replace(/ę/g, 'e')
                    .replace(/ń/g, 'n')
                    .replace(/ó/g, 'o')
                    .replace(/ś/g, 's')
                    .replace(/ź/g, 'z')
                    .replace(/ż/g, 'z');
            };
            
            // Funkcja do formatowania kwoty z PLN
            const formatPriceForPDF = (value) => {
                const formatted = formatPrice(value);
                // Dodaj " PLN" na końcu (formatPrice zwraca tylko liczbę)
                return formatted + ' PLN';
            };
            
            // Nagłówek
            doc.setFontSize(18);
            doc.text('Raport dzienny transakcji', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Data: ${dateStr}`, 105, 30, { align: 'center' });
            
            // Tabela transakcji
            let yPos = 50;
            const pageHeight = doc.internal.pageSize.height;
            const lineHeight = 8;
            const margin = 20;
            const lpColRight = margin + 15; // Prawa krawędź kolumny LP
            const kwotaColRight = 190; // Prawa krawędź kolumny Kwota
            
            // Nagłówki kolumn
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('LP', lpColRight, yPos, { align: 'right' });
            doc.text('Data', margin + 20, yPos);
            doc.text('Badania', margin + 70, yPos);
            doc.text('Kwota', kwotaColRight, yPos, { align: 'right' });
            
            yPos += lineHeight;
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, yPos, 190, yPos);
            yPos += 5;
            
            // Wiersze transakcji
            doc.setFont('helvetica', 'normal');
            transactions.forEach((transaction, index) => {
                // Sprawdź czy potrzeba nowej strony
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 20;
                }
                
                const lp = index + 1;
                let data = transaction.DATA || '';
                // Usuń przecinek i sformatuj datę: DD.MM.YYYY HH:MM
                // Format wejściowy: "DD.MM.YYYY, HH:MM:SS" -> wyjściowy: "DD.MM.YYYY HH:MM"
                data = data.replace(',', ' '); // Zamień przecinek na spację
                // Wyciągnij datę i czas (godzina:minuta)
                const dateMatch = data.match(/(\d{2}\.\d{2}\.\d{4})\s+(\d{2}):(\d{2})/);
                if (dateMatch) {
                    data = `${dateMatch[1]} ${dateMatch[2]}:${dateMatch[3]}`;
                } else {
                    // Fallback - po prostu usuń przecinek
                    data = data.replace(',', ' ');
                }
                const badania = transaction.BADANIA || '';
                const kwotaValue = parseFloat((transaction.KWOTA || '0').replace(',', '.'));
                const kwota = formatPriceForPDF(kwotaValue);
                
                // LP - wyrównane do prawej
                doc.text(lp.toString(), lpColRight, yPos, { align: 'right' });
                // Data - wyrównane do lewej (pokazuj pełną datę i czas)
                doc.text(data, margin + 20, yPos);
                // Badania - wyrównane do lewej
                const badaniaShort = badania.length > 30 ? badania.substring(0, 27) + '...' : badania;
                doc.text(badaniaShort, margin + 70, yPos);
                // Kwota - wyrównane do prawej (użyj prawidłowej pozycji)
                doc.text(kwota, kwotaColRight, yPos, { align: 'right' });
                
                yPos += lineHeight;
            });
            
            // Linia przed sumą
            yPos += 5;
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, yPos, 190, yPos);
            yPos += 10;
            
            // Suma
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            const sumaText = `Suma wszystkich transakcji: ${formatPriceForPDF(suma)}`;
            doc.text(sumaText, 190, yPos, { align: 'right' });
            
            // Stopka
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text(`Strona ${i} z ${totalPages}`, 105, pageHeight - 10, { align: 'center' });
            }
            
            // Zapisz PDF
            const fileName = `raport_dzienny_${dateStr.replace(/\./g, '_')}.pdf`;
            doc.save(fileName);
        }

        // Funkcja do generowania raportu miesięcznego PDF
        async function generateMonthlyReport() {
            const progressOverlay = document.getElementById('progressOverlay');
            const statsProgress = document.getElementById('statsProgress');
            
            try {
                // Pokaż progress
                if (progressOverlay) {
                    progressOverlay.classList.remove('hidden');
                }
                if (statsProgress) {
                    statsProgress.classList.remove('hidden');
                }
                
                // Pobierz aktualną datę z panelu lub użyj dzisiejszej daty
                const statsLabel = document.querySelector('.stats-label');
                let reportDate = new Date();
                
                // Spróbuj wyciągnąć datę z labela "Transakcje z dnia: DD.MM.YYYY, HH:MM:SS"
                const labelText = statsLabel ? statsLabel.textContent : '';
                if (labelText.includes('Transakcje z dnia:')) {
                    const dateMatch = labelText.match(/(\d{2}\.\d{2}\.\d{4})/);
                    if (dateMatch) {
                        const [day, month, year] = dateMatch[1].split('.');
                        reportDate = new Date(year, month - 1, day);
                    }
                }
                
                const year = reportDate.getFullYear();
                const month = reportDate.getMonth();
                const monthStr = String(month + 1).padStart(2, '0');
                const monthName = ['Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec', 
                                  'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'][month];
                
                // Pobierz wszystkie transakcje z miesiąca
                const allTransactions = [];
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
                const lastDayToCheck = isCurrentMonth ? today.getDate() : daysInMonth;
                
                for (let day = 1; day <= lastDayToCheck; day++) {
                    const dateStrForAPI = `${year}-${monthStr}-${String(day).padStart(2, '0')}`;
                    try {
                        const response = await fetch(`${API_BASE}/api/platnosci/by-date?date=${dateStrForAPI}`, {
                            credentials: 'include'
                        });
                        
                        if (response.status === 401) {
                            document.getElementById('loginContainer').style.display = 'block';
                            document.getElementById('appContainer').classList.remove('active');
                            return;
                        }
                        
                        const data = await response.json();
                        if (data.transactions && data.transactions.length > 0) {
                            allTransactions.push(...data.transactions);
                        }
                    } catch (error) {
                        console.error(`Błąd podczas pobierania transakcji dla ${dateStrForAPI}:`, error);
                    }
                }
                
                if (allTransactions.length === 0) {
                    alert('Brak transakcji do wygenerowania raportu dla wybranego miesiąca.');
                    // Ukryj progress
                    if (progressOverlay) {
                        progressOverlay.classList.add('hidden');
                    }
                    if (statsProgress) {
                        statsProgress.classList.add('hidden');
                    }
                    return;
                }
                
                // Załaduj bibliotekę jsPDF dynamicznie
                if (typeof window.jsPDF === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    script.onload = async () => {
                        await loadFontForPDF();
                        generateMonthlyPDF(allTransactions, year, month, monthName);
                        // Ukryj progress
                        if (progressOverlay) {
                            progressOverlay.classList.add('hidden');
                        }
                        if (statsProgress) {
                            statsProgress.classList.add('hidden');
                        }
                    };
                    document.head.appendChild(script);
                } else {
                    await loadFontForPDF();
                    generateMonthlyPDF(allTransactions, year, month, monthName);
                    // Ukryj progress
                    if (progressOverlay) {
                        progressOverlay.classList.add('hidden');
                    }
                    if (statsProgress) {
                        statsProgress.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Błąd podczas generowania raportu miesięcznego:', error);
                alert('Wystąpił błąd podczas generowania raportu miesięcznego.');
                // Ukryj progress w przypadku błędu
                if (progressOverlay) {
                    progressOverlay.classList.add('hidden');
                }
                if (statsProgress) {
                    statsProgress.classList.add('hidden');
                }
            }
        }

        function generateMonthlyPDF(transactions, year, month, monthName) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Użyj czcionki Helvetica
            doc.setFont('helvetica');
            
            // Funkcja do formatowania kwoty z PLN
            const formatPriceForPDF = (value) => {
                const formatted = formatPrice(value);
                return formatted + ' PLN';
            };
            
            // Funkcja do formatowania daty
            const formatDateForPDF = (dateStr) => {
                let data = dateStr || '';
                data = data.replace(',', ' ');
                const dateMatch = data.match(/(\d{2}\.\d{2}\.\d{4})\s+(\d{2}):(\d{2})/);
                if (dateMatch) {
                    return `${dateMatch[1]} ${dateMatch[2]}:${dateMatch[3]}`;
                } else {
                    return data.replace(',', ' ');
                }
            };
            
            // Grupuj transakcje po dniach (z pełną datą)
            const transactionsByDay = {};
            transactions.forEach(transaction => {
                const dataStr = transaction.DATA || '';
                const dateMatch = dataStr.match(/(\d{2})\.(\d{2})\.(\d{4})/);
                if (dateMatch) {
                    const day = parseInt(dateMatch[1]);
                    const month = parseInt(dateMatch[2]);
                    const year = parseInt(dateMatch[3]);
                    const dateKey = `${day}.${month}.${year}`;
                    if (!transactionsByDay[dateKey]) {
                        transactionsByDay[dateKey] = [];
                    }
                    transactionsByDay[dateKey].push(transaction);
                }
            });
            
            // Nagłówek
            doc.setFontSize(18);
            doc.text('Raport transakcji', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`${monthName} ${year}`, 105, 30, { align: 'center' });
            
            // Tabela transakcji
            let yPos = 50;
            const pageHeight = doc.internal.pageSize.height;
            const lineHeight = 8;
            const margin = 20;
            const dateColRight = margin + 70;
            const countColRight = margin + 120;
            const sumColRight = 190;
            
            // Nagłówki kolumn
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('Data', dateColRight, yPos, { align: 'right' });
            doc.text('Liczba transakcji', countColRight, yPos, { align: 'right' });
            doc.text('Suma', sumColRight, yPos, { align: 'right' });
            
            yPos += lineHeight;
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, yPos, 190, yPos);
            yPos += 5;
            
            // Wiersze - dni miesiąca
            doc.setFont('helvetica', 'normal');
            let totalSum = 0;
            // Sortuj daty (format DD.MM.YYYY)
            const sortedDates = Object.keys(transactionsByDay).sort((a, b) => {
                const [dayA, monthA, yearA] = a.split('.').map(Number);
                const [dayB, monthB, yearB] = b.split('.').map(Number);
                if (yearA !== yearB) return yearA - yearB;
                if (monthA !== monthB) return monthA - monthB;
                return dayA - dayB;
            });
            
            sortedDates.forEach(dateKey => {
                // Sprawdź czy potrzeba nowej strony
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 20;
                }
                
                const dayTransactions = transactionsByDay[dateKey];
                const count = dayTransactions.length;
                let daySum = 0;
                dayTransactions.forEach(transaction => {
                    const kwotaStr = (transaction.KWOTA || '0').replace(',', '.');
                    try {
                        daySum += parseFloat(kwotaStr);
                    } catch (e) {
                        console.error('Błąd parsowania kwoty:', kwotaStr);
                    }
                });
                totalSum += daySum;
                
                // Data - wyrównane do prawej (format DD.MM.YYYY)
                doc.text(dateKey, dateColRight, yPos, { align: 'right' });
                // Liczba transakcji - wyrównane do prawej
                doc.text(count.toString(), countColRight, yPos, { align: 'right' });
                // Suma - wyrównane do prawej
                doc.text(formatPriceForPDF(daySum), sumColRight, yPos, { align: 'right' });
                
                yPos += lineHeight;
            });
            
            // Linia przed sumą
            yPos += 5;
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, yPos, 190, yPos);
            yPos += 10;
            
            // Suma
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            const sumaText = `Suma wszystkich transakcji: ${formatPriceForPDF(totalSum)}`;
            doc.text(sumaText, 190, yPos, { align: 'right' });
            
            // Stopka
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text(`Strona ${i} z ${totalPages}`, 105, pageHeight - 10, { align: 'center' });
            }
            
            // Zapisz PDF
            const fileName = `raport_miesieczny_${monthName.toLowerCase()}_${year}.pdf`;
            doc.save(fileName);
        }
    </script>
</body>
</html>

